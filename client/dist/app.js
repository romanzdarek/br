!function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(i,n,function(t){return e[t]}.bind(null,n));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=1)}([,function(e,t,s){"use strict";var i,n,a;s.r(t),function(e){e[e.Empty=0]="Empty",e[e.Hand=1]="Hand",e[e.Pistol=2]="Pistol",e[e.Machinegun=3]="Machinegun",e[e.Shotgun=4]="Shotgun",e[e.Rifle=5]="Rifle",e[e.Hammer=6]="Hammer",e[e.Granade=7]="Granade",e[e.Smoke=8]="Smoke",e[e.Medkit=9]="Medkit"}(i||(i={})),function(e){e[e.Grass=0]="Grass",e[e.Water=1]="Water",e[e.WaterTriangle1=2]="WaterTriangle1",e[e.WaterTriangle2=3]="WaterTriangle2",e[e.WaterTriangle3=4]="WaterTriangle3",e[e.WaterTriangle4=5]="WaterTriangle4"}(n||(n={}));class o{constructor(e,t,s,i){switch(this.angle=0,this.type=e,this.x=t,this.y=s,this.size=i,e){case n.WaterTriangle2:this.angle=90;break;case n.WaterTriangle3:this.angle=180;break;case n.WaterTriangle4:this.angle=270}}}class r{constructor(e,t){this.x=e,this.y=t}}class h{constructor(e,t,s,i){this.changed=!1,this.opacity=1,this.active=!0,this.hitAnimateTimer=0,this.hitAnimateShiftX=0,this.hitAnimateShiftY=0,this.id=e,this.x=t,this.y=s,this.size=i,this.radius=i/2}getChanged(){return this.changed}nullChanged(){this.changed=!1}update(e){this.opacity=e}isPointIn(e){const t=this.x+this.radius-e.x,s=this.y+this.radius-e.y;return Math.sqrt(t*t+s*s)<=this.radius}getCenterX(){return this.x+this.size/2}getCenterY(){return this.y+this.size/2}getOpacity(){return this.opacity}isActive(){return this.active}acceptHit(e){this.opacity>.1&&(this.opacity-=.1),this.createAnimateHit(e),this.opacity<.1&&(this.active=!1)}createAnimateHit(e){const t=e.x-this.getCenterX(),s=e.y-this.getCenterY();let i=Math.abs(Math.atan(t/s)*(180/Math.PI));e.x>=this.getCenterX()&&e.y<this.getCenterY()&&(i=i),e.x>=this.getCenterX()&&e.y>=this.getCenterY()&&(i=180-i),e.x<this.getCenterX()&&e.y>=this.getCenterY()&&(i=180+i),e.x<this.getCenterX()&&e.y<this.getCenterY()&&(i=360-i),360===(i=Math.round(i))&&(i=0),this.hitAnimateTimer=10;this.hitAnimateShiftX=3*Math.sin(i*Math.PI/180)*-1,this.hitAnimateShiftY=3*Math.cos(i*Math.PI/180)}animate(){let e=0,t=0;switch(this.hitAnimateTimer>0&&this.hitAnimateTimer--,this.hitAnimateTimer){case 1:e=this.hitAnimateShiftX,t=this.hitAnimateShiftY;break;case 2:e=2*this.hitAnimateShiftX,t=2*this.hitAnimateShiftY;break;case 3:e=3*this.hitAnimateShiftX,t=3*this.hitAnimateShiftY;break;case 4:e=4*this.hitAnimateShiftX,t=4*this.hitAnimateShiftY;break;case 5:e=5*this.hitAnimateShiftX,t=5*this.hitAnimateShiftY;break;case 6:e=4*this.hitAnimateShiftX,t=4*this.hitAnimateShiftY;break;case 7:e=3*this.hitAnimateShiftX,t=3*this.hitAnimateShiftY;break;case 8:e=2*this.hitAnimateShiftX,t=2*this.hitAnimateShiftY;break;case 9:e=1*this.hitAnimateShiftX,t=1*this.hitAnimateShiftY}return new r(e,t)}}class l extends h{constructor(e,t,s){super(e,t,s,200),this.treeTrankRadius=35,this.opacity=.9}}class c extends h{constructor(e,t,s){super(e,t,s,100),this.opacity=1}}class m extends h{constructor(e,t,s){super(e,t,s,100),this.opacity=.9}}class g{constructor(e,t,s,i,n){this.changed=!1,this.opacity=1,this.active=!0,this.id=e,this.x=t,this.y=s,this.width=i,this.height=n}getChanged(){return this.changed}nullChanged(){this.changed=!1}getChangedData(){return{id:this.id,opacity:this.opacity}}update(e){this.opacity=e}isPointIn(e){const{x:t,y:s}=e;return t<this.x+this.width&&t>=this.x&&s>=this.y&&s<this.y+this.height}getOpacity(){return this.opacity}isActive(){return this.active}acceptHit(){this.active&&(this.opacity>.1&&(this.opacity-=.1),this.opacity<.1&&(this.active=!1),this.changed=!0)}}class d extends g{constructor(e,t,s,i,n){super(e,t,s,i,n)}}class p{constructor(){this.water="#69A2E0",this.grass="#A2CB69",this.blockFrame="gray",this.blockFrameActive="red",this.bullet="red",this.text="white",this.collisionPoint="red",this.player="#FFC878",this.hand="#FFC878",this.handBorder="#424242",this.vest="#424242"}}class u{constructor(e,t,s,i){this.active=!0,this.age=0,this.maxAge=10,this.startX=e,this.startY=t,this.endX=s,this.endY=i}increaseAge(){this.age++===this.maxAge&&(this.active=!1)}isActive(){return this.active}getAge(){return this.age}}class y{constructor(e,t,s){this.parts=[],this.id=e,this.startX=t,this.startY=s}getEndX(){return this.endX}getEndY(){return this.endY}setEnd(e,t){this.endX=e,this.endY=t;let s=this.startX,i=this.startY;this.parts.length&&(s=this.parts[this.parts.length-1].endX,i=this.parts[this.parts.length-1].endY),this.parts.push(new u(s,i,e,t))}isActive(){return!this.parts.length||this.parts[this.parts.length-1].isActive()}}!function(e){e[e.Pistol=0]="Pistol",e[e.Machinegun=1]="Machinegun",e[e.Shotgun=2]="Shotgun",e[e.Rifle=3]="Rifle",e[e.Hammer=4]="Hammer",e[e.RedAmmo=5]="RedAmmo",e[e.GreenAmmo=6]="GreenAmmo",e[e.BlueAmmo=7]="BlueAmmo",e[e.OrangeAmmo=8]="OrangeAmmo",e[e.Vest=9]="Vest",e[e.Medkit=10]="Medkit",e[e.Granade=11]="Granade",e[e.Smoke=12]="Smoke",e[e.Scope2=13]="Scope2",e[e.Scope4=14]="Scope4",e[e.Scope6=15]="Scope6"}(a||(a={}));class w{constructor(){this.loadingMax=40,this.loading=this.loadingMax,this.scope=.3,this.scopeLoadingChange=0,this.scopeResolutionAdjustment=.3}setScope(e){switch(e){case 2:e=1.2;break;case 4:e=1.4;break;case 6:e=1.6}const t=this.scope;this.scope=e,e!==t&&(this.scopeLoadingChange=(e-t)/this.loadingMax,this.loading=0)}getFinalResolutionAdjustment(e){return this.loading!==this.loadingMax&&(this.scopeResolutionAdjustment+=this.scopeLoadingChange,this.loading++),e/this.scopeResolutionAdjustment}}class b{constructor(e,t,s,i,a,o,r){this.resolutionAdjustment=1,this.finalResolutionAdjustment=1,this.bulletLines=[],this.takeLootText="",this.scope=new w,this.snapshotManager=r,this.colors=new p,this.serverClientSync=i,this.myHtmlElements=a,this.map=e,this.collisionPoints=o,this.mouse=t,this.gameScreen=this.myHtmlElements.gameScreen,this.editorScreen=this.myHtmlElements.editor.screen,this.mapScreen=this.myHtmlElements.mapScreen,this.helperScreen=this.myHtmlElements.helperScreen,this.ctxGame=this.gameScreen.getContext("2d"),this.ctxMap=this.mapScreen.getContext("2d"),this.ctxEditor=this.editorScreen.getContext("2d"),this.bushSVG=new Image,this.bushSVG.src="img/bush.svg",this.rockSVG=new Image,this.rockSVG.src="img/rock.svg",this.treeSVG=new Image,this.treeSVG.src="img/tree.svg",this.cursorSVG=new Image,this.cursorSVG.src="img/cursor.svg",this.loadingProgresSVG=new Image,this.loadingProgresSVG.src="img/loadingProgres.svg",this.loadingCircleSVG=new Image,this.loadingCircleSVG.src="img/loadingCircle.svg",this.pistolSVG=new Image,this.pistolSVG.src="img/pistol.svg",this.machinegunSVG=new Image,this.machinegunSVG.src="img/machinegun.svg",this.rifleSVG=new Image,this.rifleSVG.src="img/rifle.svg",this.shotgunSVG=new Image,this.shotgunSVG.src="img/shotgun.svg",this.hammerSVG=new Image,this.hammerSVG.src="img/hammer.svg",this.granadeSVG=new Image,this.granadeSVG.src="img/granade.svg",this.smokeSVG=new Image,this.smokeSVG.src="img/smoke.svg",this.medkitSVG=new Image,this.medkitSVG.src="img/medkit.svg",this.smokeCloudSVG=new Image,this.smokeCloudSVG.src="img/smokeCloud.svg",this.rifleLootSVG=new Image,this.rifleLootSVG.src="img/rifleLoot.svg",this.pistolLootSVG=new Image,this.pistolLootSVG.src="img/pistolLoot.svg",this.shotgunLootSVG=new Image,this.shotgunLootSVG.src="img/shotgunLoot.svg",this.machinegunLootSVG=new Image,this.machinegunLootSVG.src="img/machinegunLoot.svg",this.hammerLootSVG=new Image,this.hammerLootSVG.src="img/hammerLoot.svg",this.granadeLootSVG=new Image,this.granadeLootSVG.src="img/granadeLoot.svg",this.smokeLootSVG=new Image,this.smokeLootSVG.src="img/smokeLoot.svg",this.redAmmoLootSVG=new Image,this.redAmmoLootSVG.src="img/redAmmoLoot.svg",this.greenAmmoLootSVG=new Image,this.greenAmmoLootSVG.src="img/greenAmmoLoot.svg",this.blueAmmoLootSVG=new Image,this.blueAmmoLootSVG.src="img/blueAmmoLoot.svg",this.orangeAmmoLootSVG=new Image,this.orangeAmmoLootSVG.src="img/orangeAmmoLoot.svg",this.medkitLootSVG=new Image,this.medkitLootSVG.src="img/medkitLoot.svg",this.vestLootSVG=new Image,this.vestLootSVG.src="img/vestLoot.svg",this.scope2LootSVG=new Image,this.scope2LootSVG.src="img/scope2Loot.svg",this.scope4LootSVG=new Image,this.scope4LootSVG.src="img/scope4Loot.svg",this.scope6LootSVG=new Image,this.scope6LootSVG.src="img/scope6Loot.svg",this.deadPlayer=new Image,this.deadPlayer.src="img/deadPlayer.svg",this.waterTrianglePNG=new Image,this.waterTrianglePNG.src="img/waterTriangle.png",this.waterTerrainData=s,this.waterTrianglePNG.onload=()=>{this.saveWaterPixels(n.WaterTriangle1),this.saveWaterPixels(n.WaterTriangle2),this.saveWaterPixels(n.WaterTriangle3),this.saveWaterPixels(n.WaterTriangle4)},this.screenResize()}reset(){this.myPlayer=null,this.scope=new w}screenResize(){const e=this.myHtmlElements;this.gameScreen.width=window.innerWidth,this.gameScreen.height=window.innerHeight,e.zoneSVG.setAttribute("width",window.innerWidth.toString()),e.zoneSVG.setAttribute("height",window.innerHeight.toString());const t=Math.floor((window.innerWidth/5+window.innerHeight/5)/2);this.mapScreen.width=t,this.mapScreen.height=t,e.mapZoneSVG.setAttribute("width",t.toString()),e.mapZoneSVG.setAttribute("height",t.toString()),e.mapContainer.style.width=(t+10).toString()+"px",e.mapContainer.style.height=(t+10).toString()+"px",this.screenCenterX=window.innerWidth/2,this.screenCenterY=window.innerHeight/2,this.changeResolutionAdjustment(),this.myPlayer&&this.drawGame(this.myPlayer.id)}calculateServerPosition(e){let t,s;return t=this.screenCenterX>e.x?-1*(this.screenCenterX-e.x):e.x-this.screenCenterX,s=this.screenCenterY>e.y?-1*(this.screenCenterY-e.y):e.y-this.screenCenterY,t/=this.finalResolutionAdjustment,s/=this.finalResolutionAdjustment,t+=this.myPlayer.getCenterX(),s+=this.myPlayer.getCenterY(),new r(t,s)}changeResolutionAdjustment(){const e=(this.gameScreen.width/1920+this.gameScreen.height/1050)/2;this.resolutionAdjustment=e}saveWaterPixels(e){const t=this.helperScreen.getContext("2d");this.helperScreen.width=this.waterTrianglePNG.width,this.helperScreen.height=this.waterTrianglePNG.height,t.fillStyle="#FFFFFF",t.fillRect(0,0,this.helperScreen.width,this.helperScreen.height);let s=this.waterTrianglePNG.width/2;switch(t.save(),t.translate(s,s),e){case n.WaterTriangle1:t.rotate(0*Math.PI/180);break;case n.WaterTriangle2:t.rotate(90*Math.PI/180);break;case n.WaterTriangle3:t.rotate(180*Math.PI/180);break;case n.WaterTriangle4:t.rotate(270*Math.PI/180)}if(t.drawImage(this.waterTrianglePNG,-s,-s),t.restore(),"undefined"!=typeof Worker){const s=new Worker("workerFindWater.js");s.onmessage=e=>{this.waterTerrainData.setData(e.data.type,e.data.data)};const i=t.getImageData(0,0,this.waterTrianglePNG.width,this.waterTrianglePNG.height).data;s.postMessage({data:i,size:this.waterTrianglePNG.width,type:e,time:(new Date).getTime()})}else console.log("Your browser doesn't support web workers.")}drawMap(){const e=this.ctxMap,t=this.myHtmlElements;e.clearRect(0,0,this.mapScreen.width,this.mapScreen.height),e.fillStyle=this.colors.grass,e.fillRect(0,0,this.mapScreen.width,this.mapScreen.height);const s=this.mapScreen.width/(this.map.getSize()/this.map.getBlockSize()),i=s/this.map.getBlockSize(),a=s+s/50;for(const t of this.map.terrain){const o=t.x*i,r=t.y*i;if(t.type===n.Water&&(e.fillStyle=this.colors.water,e.fillRect(o,r,a,a)),t.type!==n.Water){const i=a/2;e.save(),e.translate(o+i,r+i),e.rotate(t.angle*Math.PI/180),e.drawImage(this.waterTrianglePNG,-i,-i,s,s),e.restore()}}{const t=this.mapScreen.width/40,s=this.myPlayer.getCenterX()*i-t/2,n=this.myPlayer.getCenterY()*i-t/2;e.beginPath(),e.arc(s,n,t,0,2*Math.PI),e.fillStyle=this.colors.player,e.fill()}{const t=this.snapshotManager.zone.innerCircle.getCenterX()*i,s=this.snapshotManager.zone.innerCircle.getCenterY()*i,n=this.snapshotManager.zone.innerCircle.getRadius()*i;e.beginPath(),e.arc(t,s,n,0,2*Math.PI),e.strokeStyle="green",e.stroke()}{const e=this.snapshotManager.zone.outerCircle.getCenterX()*i,s=this.snapshotManager.zone.outerCircle.getCenterY()*i,n=this.snapshotManager.zone.outerCircle.getRadius()*i;t.mapZoneCircle.setAttribute("r",n.toString()),t.mapZoneCircle.setAttribute("cx",e.toString()),t.mapZoneCircle.setAttribute("cy",s.toString())}}drawEditor(e){const t=this.ctxEditor;t.clearRect(0,0,this.editorScreen.width,this.editorScreen.height),t.fillStyle=this.colors.grass,t.fillRect(0,0,this.editorScreen.width,this.editorScreen.height),t.fillStyle=this.colors.water;for(const s of e.terrains)switch(s.type){case n.Water:t.fillRect(s.x,s.y,e.blockSize,e.blockSize);break;case n.WaterTriangle1:t.drawImage(this.waterTrianglePNG,s.x,s.y,e.blockSize,e.blockSize);break;case n.WaterTriangle2:case n.WaterTriangle3:case n.WaterTriangle4:let i=e.blockSize/2;t.save(),t.translate(s.x+i,s.y+i),t.rotate(s.angle*Math.PI/180),t.drawImage(this.waterTrianglePNG,-i,-i,e.blockSize,e.blockSize),t.restore()}let s,i;if(null!=e.getTerrainType()){s=Math.floor(e.getX()/e.blockSize)*e.blockSize,i=Math.floor(e.getY()/e.blockSize)*e.blockSize;let a=-1;switch(e.getTerrainType()){case n.Water:t.fillStyle=this.colors.water,t.fillRect(s,i,e.blockSize,e.blockSize);break;case n.Grass:t.fillStyle=this.colors.grass,t.fillRect(s,i,e.blockSize,e.blockSize);break;case n.WaterTriangle1:a=0;break;case n.WaterTriangle2:a=90;break;case n.WaterTriangle3:a=180;break;case n.WaterTriangle4:a=270}if(-1!==a){t.fillStyle=this.colors.grass,t.fillRect(s,i,e.blockSize,e.blockSize);let n=e.blockSize/2;t.save(),t.translate(s+n,i+n),t.rotate(a*Math.PI/180),t.drawImage(this.waterTrianglePNG,-n,-n,e.blockSize,e.blockSize),t.restore()}}t.fillStyle=this.colors.blockFrame;for(let s=0;s<e.getSize();s++)t.fillRect(s*e.blockSize,0,1,e.getSize()*e.blockSize);for(let s=0;s<e.getSize();s++)t.fillRect(0,s*e.blockSize,e.getSize()*e.blockSize,1);null!=e.getTerrainType()&&(t.fillStyle=this.colors.blockFrameActive,t.fillRect(s,i,e.blockSize,1),t.fillRect(s,i+e.blockSize,e.blockSize,1),t.fillRect(s,i,1,e.blockSize),t.fillRect(s+e.blockSize,i,1,e.blockSize)),t.save(),"delete"===e.getObjectType()&&(t.globalAlpha=.6);for(const s of e.rocks)t.drawImage(this.rockSVG,s.x,s.y,s.size,s.size);t.fillStyle="black";for(const s of e.walls)t.fillRect(s.x,s.y,s.width,s.height);for(const s of e.bushes)t.drawImage(this.bushSVG,s.x,s.y,s.size,s.size);for(const s of e.trees)t.drawImage(this.treeSVG,s.x,s.y,s.size,s.size);if(t.restore(),"delete"===e.getObjectType()){let s;for(const t of e.rocks){const i=t;i.x<=e.getX()&&i.x+i.size>=e.getX()&&i.y<=e.getY()&&i.y+i.size>=e.getY()&&(s=i)}for(const t of e.walls){const i=t;i.x<=e.getX()&&i.x+i.width>=e.getX()&&i.y<=e.getY()&&i.y+i.height>=e.getY()&&(s=i)}for(const t of e.bushes){const i=t;i.x<=e.getX()&&i.x+i.size>=e.getX()&&i.y<=e.getY()&&i.y+i.size>=e.getY()&&(s=i)}for(const t of e.trees){const i=t;i.x<=e.getX()&&i.x+i.size>=e.getX()&&i.y<=e.getY()&&i.y+i.size>=e.getY()&&(s=i)}s instanceof c&&t.drawImage(this.rockSVG,s.x,s.y,s.size,s.size),s instanceof m&&t.drawImage(this.bushSVG,s.x,s.y,s.size,s.size),s instanceof l&&t.drawImage(this.treeSVG,s.x,s.y,s.size,s.size),s instanceof d&&(t.fillStyle="black",t.fillRect(s.x,s.y,s.width,s.height))}if(e.getObjectType()){let s;switch(e.getObjectType()){case"bush":s=e.bush.size,t.drawImage(this.bushSVG,e.getX()-s/2,e.getY()-s/2,s,s);break;case"rock":s=e.rock.size,t.drawImage(this.rockSVG,e.getX()-s/2,e.getY()-s/2,s,s);break;case"tree":s=e.tree.size,t.drawImage(this.treeSVG,e.getX()-s/2,e.getY()-s/2,s,s);break;case"rect":s=e.rock.size,t.fillStyle="black",t.fillRect(e.getX()-s/2,e.getY()-s/2,s,s)}}}drawGame(e){const t=this.snapshotManager.betweenSnapshot,s=this.snapshotManager.players;if(!t)return;-1!==t.i.spectate&&(e=t.i.spectate);for(const t of s)if(t.id===e){this.myPlayer=t;break}if(!this.myPlayer)return;this.scope.setScope(this.snapshotManager.betweenSnapshot.i.s),this.finalResolutionAdjustment=this.scope.getFinalResolutionAdjustment(this.resolutionAdjustment),this.drawMap();const o=this.ctxGame,r=this.myHtmlElements;o.clearRect(0,0,this.gameScreen.width,this.gameScreen.height),o.fillStyle=this.colors.water,o.fillRect(0,0,this.gameScreen.width,this.gameScreen.height),o.fillStyle=this.colors.grass;for(const e of this.map.blocks){const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw({x:e.x,y:e.y,size:300});n&&o.fillRect(t,s,i,i)}o.fillStyle=this.colors.water;for(const e of this.map.terrain){const{x:t,y:s,width:i,height:a,isOnScreen:r}=this.howToDraw({x:e.x,y:e.y,size:e.size});if(r)if(e.type===n.Water)o.fillRect(t,s,i,a);else if(e.type===n.WaterTriangle1)o.drawImage(this.waterTrianglePNG,t,s,i,a);else if(e.type===n.WaterTriangle2||e.type===n.WaterTriangle3||e.type===n.WaterTriangle4){let n=i/2;o.save(),o.translate(t+n,s+n),o.rotate(e.angle*Math.PI/180),o.drawImage(this.waterTrianglePNG,-n,-n,i,a),o.restore()}}o.fillStyle=this.colors.blockFrame;const h=1*this.resolutionAdjustment;for(const e of this.map.blocks){if(0===e.y){const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw({x:e.x,y:e.y,size:300});n&&o.fillRect(t,s,i,h)}{const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw({x:e.x,y:e.y+300,size:300});n&&o.fillRect(t,s,i,h)}if(0===e.x){const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw({x:e.x,y:e.y,size:300});n&&o.fillRect(t,s,h,i)}{const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw({x:e.x+300,y:e.y,size:300});n&&o.fillRect(t,s,h,i)}}for(const e of this.map.rocks)if(e.isActive()){const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw(e);n&&(o.save(),o.globalAlpha=e.getOpacity(),o.drawImage(this.rockSVG,t,s,i,i),o.restore())}o.fillStyle="black";for(const e of this.map.rectangleObstacles)if(e.isActive()){const{x:t,y:s,width:i,height:n,isOnScreen:a}=this.howToDraw(e);a&&(o.save(),o.globalAlpha=e.getOpacity(),o.fillRect(t,s,i,n),o.restore())}for(const e of s){if(e.alive())continue;const{x:t,y:s,width:i,height:n,isOnScreen:a}=this.howToDraw({x:e.getX(),y:e.getY(),size:e.size});a&&o.drawImage(this.deadPlayer,t,s,i,n)}for(const e of t.l){const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw(e);let r;switch(e.type){case a.Pistol:r=this.pistolLootSVG;break;case a.Machinegun:r=this.machinegunLootSVG;break;case a.Shotgun:r=this.shotgunLootSVG;break;case a.Rifle:r=this.rifleLootSVG;break;case a.Smoke:r=this.smokeLootSVG;break;case a.Granade:r=this.granadeLootSVG;break;case a.Hammer:r=this.hammerLootSVG;break;case a.RedAmmo:r=this.redAmmoLootSVG;break;case a.BlueAmmo:r=this.blueAmmoLootSVG;break;case a.GreenAmmo:r=this.greenAmmoLootSVG;break;case a.OrangeAmmo:r=this.orangeAmmoLootSVG;break;case a.Vest:r=this.vestLootSVG;break;case a.Medkit:r=this.medkitLootSVG;break;case a.Scope2:r=this.scope2LootSVG;break;case a.Scope4:r=this.scope4LootSVG;break;case a.Scope6:r=this.scope6LootSVG}o.drawImage(r,t,s,i,i)}for(const e of s){if(!e.alive())continue;const{x:t,y:s,size:n,isOnScreen:a}=this.howToDraw({x:e.getX(),y:e.getY(),size:e.size});if(a){const e=n/2;o.beginPath(),o.arc(t+e,s+e,e,0,2*Math.PI);let i=this.colors.player;this.snapshotManager.betweenSnapshot.i.v&&(i=this.colors.vest),o.fillStyle=i,o.fill();let a=.92*e;o.beginPath(),o.arc(t+e,s+e,a,0,2*Math.PI),o.fillStyle=this.colors.player,o.fill()}const r=280;if(e.getWeapon()===i.Pistol){const t=e.getCenterX()-r/2,s=e.getCenterY()-r/2,{x:i,y:n,size:a,isOnScreen:h}=this.howToDraw({x:t,y:s,size:r});if(h){let t=a/2;o.save(),o.translate(i+t,n+t),o.rotate(e.getAngle()*Math.PI/180),o.drawImage(this.pistolSVG,-t,-t,a,a),o.restore()}}if(e.getWeapon()===i.Machinegun){const t=e.getCenterX()-r/2,s=e.getCenterY()-r/2,{x:i,y:n,size:a,isOnScreen:h}=this.howToDraw({x:t,y:s,size:r});if(h){let t=a/2;o.save(),o.translate(i+t,n+t),o.rotate(e.getAngle()*Math.PI/180),o.drawImage(this.machinegunSVG,-t,-t,a,a),o.restore()}}if(e.getWeapon()===i.Shotgun){const t=e.getCenterX()-r/2,s=e.getCenterY()-r/2,{x:i,y:n,size:a,isOnScreen:h}=this.howToDraw({x:t,y:s,size:r});if(h){let t=a/2;o.save(),o.translate(i+t,n+t),o.rotate(e.getAngle()*Math.PI/180),o.drawImage(this.shotgunSVG,-t,-t,a,a),o.restore()}}if(e.getWeapon()===i.Rifle){const t=e.getCenterX()-r/2,s=e.getCenterY()-r/2,{x:i,y:n,size:a,isOnScreen:h}=this.howToDraw({x:t,y:s,size:r});if(h){let t=a/2;o.save(),o.translate(i+t,n+t),o.rotate(e.getAngle()*Math.PI/180),o.drawImage(this.rifleSVG,-t,-t,a,a),o.restore()}}if(e.getWeapon()===i.Hammer){const t=e.getCenterX()-r/2,s=e.getCenterY()-r/2,{x:i,y:n,size:a,isOnScreen:h}=this.howToDraw({x:t,y:s,size:r});if(h){let t=a/2;if(o.save(),o.translate(i+t,n+t),o.rotate(e.getHammerAngle()*Math.PI/180),o.drawImage(this.hammerSVG,-t,-t,a,a),o.restore(),this.collisionPoints.isReady()){o.fillStyle=this.colors.collisionPoint;for(const t of this.collisionPoints.hammer[e.getHammerAngle()]){const{x:s,y:i,size:n}=this.howToDraw({x:e.getCenterX()-100+t.x,y:e.getCenterY()-100+t.y,size:1});o.fillRect(s,i,n,n)}}}}if(e.getWeapon()===i.Hand||e.getWeapon()===i.Granade||e.getWeapon()===i.Smoke||e.getWeapon()===i.Medkit)for(let t=0;t<2;t++){const{x:s,y:n,size:a,isOnScreen:r}=this.howToDraw({x:e.hands[t].getX(),y:e.hands[t].getY(),size:e.hands[t].size});if(r){const r=a/2;o.beginPath(),o.arc(s+r,n+r,r,0,2*Math.PI),o.fillStyle=this.colors.handBorder,o.fill();const h=.8*r;if(o.beginPath(),o.arc(s+r,n+r,h,0,2*Math.PI),o.fillStyle=this.colors.hand,o.fill(),(e.getWeapon()===i.Granade||e.getWeapon()===i.Smoke||e.getWeapon()===i.Medkit)&&1===t){const s=e.getAngle(),n=1.2,a=e.hands[t].radius*n,r=Math.sin(s*Math.PI/180)*a,h=Math.cos(s*Math.PI/180)*a,{x:l,y:c,size:m,isOnScreen:g}=this.howToDraw({x:e.hands[t].getCenterX()+r-e.hands[t].radius*n,y:e.hands[t].getCenterY()-h-e.hands[t].radius*n,size:e.hands[t].size*n});if(g){const t=30;let n,a=m/2;o.save(),o.translate(l+a,c+a),o.rotate((s-t)*Math.PI/180),e.getWeapon()===i.Granade&&(n=this.granadeSVG),e.getWeapon()===i.Smoke&&(n=this.smokeSVG),e.getWeapon()===i.Medkit&&(n=this.medkitSVG),o.drawImage(n,-a,-a,m,m),o.restore()}}}}e.getWeapon()===i.Pistol&&(this.drawHandOnWeapon(e,27,0),this.drawHandOnWeapon(e,60,12)),e.getWeapon()===i.Machinegun&&(this.drawHandOnWeapon(e,27,0),this.drawHandOnWeapon(e,75,10)),e.getWeapon()===i.Shotgun&&(this.drawHandOnWeapon(e,27,0),this.drawHandOnWeapon(e,75,10)),e.getWeapon()===i.Rifle&&(this.drawHandOnWeapon(e,27,0),this.drawHandOnWeapon(e,80,9)),e.getWeapon()===i.Hammer&&(this.drawHandOnWeapon(e,40,30),this.drawHandOnWeapon(e,40,-30))}for(const e of this.snapshotManager.players){o.fillStyle=this.colors.collisionPoint;for(let t=e.bloods.length-1;t>=0;t--){const s=e.bloods[t];if(s.getTimer()<s.timerMax){s.shift();const t=e.getCenterX()+s.getX(),i=e.getCenterY()+s.getY(),{x:n,y:a,size:r,isOnScreen:h}=this.howToDraw({x:t,y:i,size:s.size});if(h){const e=1-s.getTimer()/s.timerMax;o.save(),o.globalAlpha=e,o.fillRect(n,a,r,r),o.restore()}}else e.bloods.splice(t,1)}}for(const e of t.g){const t=40*e.b,{x:s,y:i,size:n,isOnScreen:a}=this.howToDraw({x:e.x-t/2,y:e.y-t/2,size:t});if(a){let t=n/2;o.save(),o.translate(s+t,i+t),o.rotate(e.a*Math.PI/180),"g"===e.t&&o.drawImage(this.granadeSVG,-t,-t,n,n),"s"===e.t&&o.drawImage(this.smokeSVG,-t,-t,n,n),o.restore()}}o.fillStyle="orange";for(const e of t.b){const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw({x:e.x,y:e.y,size:3});n&&o.fillRect(t-1.5*this.finalResolutionAdjustment,s-1.5*this.finalResolutionAdjustment,i,i)}this.createBulletLines();for(const e of this.bulletLines)for(const t of e.parts)if(t.isActive()){o.save(),o.globalAlpha=.7-t.getAge()/14.3,o.beginPath();const{x:e,y:s}=this.howToDraw({x:t.startX,y:t.startY,size:1});o.moveTo(e,s);const{x:i,y:n}=this.howToDraw({x:t.endX,y:t.endY,size:1});o.lineTo(i,n),o.lineWidth=3-t.getAge()/3.33,o.strokeStyle="white",o.stroke(),o.restore(),t.increaseAge()}for(const e of this.map.bushes)if(e.isActive()){const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw(e);n&&(o.save(),o.globalAlpha=e.getOpacity(),o.drawImage(this.bushSVG,t,s,i,i),o.restore())}for(const e of this.map.trees)if(e.isActive()){const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw(e);n&&(o.save(),o.globalAlpha=e.getOpacity(),o.drawImage(this.treeSVG,t,s,i,i),o.restore())}for(const e of t.s){const{x:t,y:s,size:i,isOnScreen:n}=this.howToDraw({x:e.x-e.s/2,y:e.y-e.s/2,size:e.s});n&&(o.save(),o.globalAlpha=e.o,o.drawImage(this.smokeCloudSVG,t,s,i,i),o.restore())}const{x:l,y:c,size:m}=this.howToDraw({x:this.snapshotManager.zone.outerCircle.getCenterX(),y:this.snapshotManager.zone.outerCircle.getCenterY(),size:this.snapshotManager.zone.outerCircle.getRadius()});r.zoneCircle.setAttribute("r",m.toString()),r.zoneCircle.setAttribute("cx",l.toString()),r.zoneCircle.setAttribute("cy",c.toString());{o.font="20px Arial",o.fillStyle=this.colors.text;const e=15;let t=30,s=8;o.fillText("newerSnapshots: "+this.snapshotManager.sumaNewer,e,t*++s),o.fillText("ping: "+this.serverClientSync.getPing(),e,t*++s),o.fillText("timeDiference: "+this.serverClientSync.getTimeDiference(),e,t*++s),o.fillText("drawDelay: "+this.serverClientSync.getDrawDelay(),e,t*++s),this.snapshotManager.olderExists||o.fillText("olderSnapshot missing",e,t*++s),this.snapshotManager.newerExists||o.fillText("newerSnapshot missing",e,t*++s)}r.healthBar.in.style.width=t.i.h+"%";const g=Math.round(t.i.l/t.i.lE*100),d=Math.round((t.i.lE-t.i.l)/1e3*10)/10;if(d&&this.myPlayer.alive()){r.takeLoot.style.display="none",r.loading.main.style.visibility="visible",r.loading.text.style.display="block",r.loading.text.textContent=t.i.lT;let e=d.toString();switch(e){case"0":e=" 0.0";break;case"1":e=" 1.0";break;case"2":e=" 2.0";break;case"3":e=" 3.0";break;case"4":e=" 4.0";break;case"5":e=" 5.0"}r.loading.counter.textContent=e,r.loading.circle.setAttribute("stroke-dasharray",g+", 100")}else r.loading.main.style.visibility="hidden",r.loading.text.style.display="none",r.takeLoot.style.display="block",this.takeLootInfo();r.items.redAmmo.textContent=this.snapshotManager.betweenSnapshot.i.r.toString(),r.items.greenAmmo.textContent=this.snapshotManager.betweenSnapshot.i.g.toString(),r.items.blueAmmo.textContent=this.snapshotManager.betweenSnapshot.i.b.toString(),r.items.orangeAmmo.textContent=this.snapshotManager.betweenSnapshot.i.o.toString(),r.items.item1in.textContent=this.itemName(this.snapshotManager.betweenSnapshot.i.i1),r.items.item2in.textContent=this.itemName(this.snapshotManager.betweenSnapshot.i.i2),this.itemAmmoColor(1,this.snapshotManager.betweenSnapshot.i.i1),this.itemAmmoColor(2,this.snapshotManager.betweenSnapshot.i.i2),r.items.item3in.textContent=this.itemName(this.snapshotManager.betweenSnapshot.i.i3);let p=this.itemName(this.snapshotManager.betweenSnapshot.i.i4);const u=this.snapshotManager.betweenSnapshot.i.s4;p&&(p+=" "+u),r.items.item4in.textContent=p;let y=this.itemName(this.snapshotManager.betweenSnapshot.i.i5);const w=this.snapshotManager.betweenSnapshot.i.s5;y&&(y+=" "+w),r.items.item5in.textContent=y,this.activeItem(t.i.ai);let b="";this.myPlayer.getWeapon()===i.Pistol||this.myPlayer.getWeapon()===i.Rifle||this.myPlayer.getWeapon()===i.Machinegun||this.myPlayer.getWeapon()===i.Shotgun?b=t.i.a.toString():this.myPlayer.getWeapon()===i.Hand||this.myPlayer.getWeapon()===i.Hammer?b="âˆž":this.myPlayer.getWeapon()===i.Granade||this.myPlayer.getWeapon()===i.Smoke?b=u.toString():this.myPlayer.getWeapon()===i.Medkit&&(b=w.toString()),r.activeGunAmmo.textContent=b;let S=0;for(const e of this.snapshotManager.players)e.alive()&&S++;r.alive.textContent=S.toString();let f="none";if(1!==this.snapshotManager.betweenSnapshot.i.s)switch(f="block",this.snapshotManager.betweenSnapshot.i.s){case 2:r.items.scope2.style.display="block",r.items.scope4.style.display="none",r.items.scope6.style.display="none";break;case 4:r.items.scope2.style.display="none",r.items.scope4.style.display="block",r.items.scope6.style.display="none";break;case 6:r.items.scope2.style.display="none",r.items.scope4.style.display="none",r.items.scope6.style.display="block"}r.items.scope.style.display=f,f="none",this.snapshotManager.betweenSnapshot.i.v&&(f="block"),r.items.vest.style.display=f,this.snapshotManager.messageManager(),r.messages.innerHTML="";for(let e=this.snapshotManager.messages.length-1;e>=0;e--){const t=this.snapshotManager.messages[e],s=document.createElement("p");s.textContent=t.text,r.messages.appendChild(s)}if(this.snapshotManager.betweenSnapshot.z.hasOwnProperty("d")){let e="";this.snapshotManager.betweenSnapshot.z.d>0?e+=this.snapshotManager.betweenSnapshot.z.d:e="Zone is moving!",r.zoneTimer.innerText=e}r.spectate.style.display="none",t.i.spectateName&&(r.spectateName.innerText=t.i.spectateName,r.spectate.style.display="block")}drawHandOnWeapon(e,t,s){const n=this.ctxGame;let a=s+e.getAngle();e.getWeapon()===i.Hammer&&(a=s+e.getHammerAngle()),a>=360&&(a-=360);const o=Math.sin(a*Math.PI/180)*t,r=Math.cos(a*Math.PI/180)*t,h=e.getCenterX()+o-e.hands[0].radius,l=e.getCenterY()-r-e.hands[0].radius,{x:c,y:m,size:g,isOnScreen:d}=this.howToDraw({x:h,y:l,size:e.hands[0].size});if(d){const e=g/2;n.beginPath(),n.arc(c+e,m+e,e,0,2*Math.PI),n.fillStyle=this.colors.handBorder,n.fill();const t=.8*e;n.beginPath(),n.arc(c+e,m+e,t,0,2*Math.PI),n.fillStyle=this.colors.hand,n.fill()}}createBulletLines(){for(const e of this.snapshotManager.betweenSnapshot.b){let t=!1;for(const s of this.bulletLines)if(s.id===e.id){s.setEnd(e.x,e.y),t=!0;break}t||this.bulletLines.push(new y(e.id,e.x,e.y))}for(let e=this.bulletLines.length-1;e>=0;e--)this.bulletLines[e].isActive()||this.bulletLines.splice(e,1)}activeItem(e){const t=this.myHtmlElements;switch(t.items.item1.classList.remove("active"),t.items.item2.classList.remove("active"),t.items.item3.classList.remove("active"),t.items.item4.classList.remove("active"),t.items.item5.classList.remove("active"),e){case 1:t.items.item1.classList.add("active");break;case 2:t.items.item2.classList.add("active");break;case 3:t.items.item3.classList.add("active");break;case 4:t.items.item4.classList.add("active");break;case 5:t.items.item5.classList.add("active")}}itemAmmoColor(e,t){let s;1===e?s=this.myHtmlElements.items.item1Ammo:2===e&&(s=this.myHtmlElements.items.item2Ammo);let n="transparent";switch(t){case i.Pistol:n="orange";break;case i.Machinegun:n="blue";break;case i.Rifle:n="Green";break;case i.Shotgun:n="red"}s&&(s.style.background=n)}itemName(e){let t="";return e===i.Pistol&&(t="Pistol"),e===i.Rifle&&(t="Rifle"),e===i.Machinegun&&(t="Machinegun"),e===i.Shotgun&&(t="Shotgun"),e===i.Granade&&(t="Granade"),e===i.Smoke&&(t="Smoke"),e===i.Hand&&(t="Hands"),e===i.Hammer&&(t="Hammer"),e===i.Medkit&&(t="Medkit"),t}takeLootInfo(){const e=this.myHtmlElements;let t="";if(this.snapshotManager.betweenSnapshot&&this.myPlayer.alive()){for(const s of this.snapshotManager.betweenSnapshot.l){const i=this.myPlayer.getCenterX()-(s.x+s.size/2),n=this.myPlayer.getCenterY()-(s.y+s.size/2);if(Math.sqrt(i*i+n*n)<this.snapshotManager.players[0].radius+s.size/2){let i="";switch(s.type){case a.BlueAmmo:case a.RedAmmo:case a.GreenAmmo:case a.OrangeAmmo:i="Ammo";break;case a.Pistol:i="Pistol";break;case a.Rifle:i="Rifle";break;case a.Machinegun:i="Machinegun";break;case a.Shotgun:i="Shotgun";break;case a.Scope2:i="2X scope";break;case a.Scope4:i="4X scope";break;case a.Scope6:i="6X scope";break;case a.Granade:i="Granade";break;case a.Smoke:i="Smoke";break;case a.Medkit:i="Medkit";break;case a.Vest:i="Vest";break;case a.Hammer:i="Hammer"}let n="";return s.quantity&&(n+=s.quantity),t=i+" "+n+" (E)",void(e.takeLoot.innerText=t)}}e.takeLoot.innerText=t}else e.takeLoot.innerText=t}howToDraw(e){let t=0,s=0,i=0;e.size?(s=t=e.size*this.finalResolutionAdjustment,i=t):(s=e.width*this.finalResolutionAdjustment,i=e.height*this.finalResolutionAdjustment);let n=0,a=0;if(e instanceof h){const t=e.animate();n=t.x,a=t.y}const o=this.screenCenterX+(e.x+n-this.myPlayer.getCenterX())*this.finalResolutionAdjustment,r=this.screenCenterY+(e.y+a-this.myPlayer.getCenterY())*this.finalResolutionAdjustment;let l=!0;return(o>this.gameScreen.width||o<-s||r>this.gameScreen.height||r<-i)&&(l=!1),{x:o,y:r,size:t,width:s,height:i,isOnScreen:l}}gameOver(e,t,s){setTimeout(()=>{const i=this.myHtmlElements;t||s?(i.gameOverMenu.h1.textContent="Winner!",s&&(i.gameOverMenu.h1.textContent=s+" win"),i.gameOverMenu.spectate.style.display="none"):(i.gameOverMenu.h1.textContent="You died",i.gameOverMenu.spectate.style.display="block"),i.open(i.gameOverMenu.main),i.gameOverMenu.stats.innerHTML="";const n=document.createElement("p");n.textContent="Kills: "+e.kills.toString();const a=document.createElement("p");a.textContent="Damage dealt: "+e.damageDealt.toString();const o=document.createElement("p");o.textContent="Damage taken: "+e.damageTaken.toString();const r=document.createElement("p"),h=Math.floor(e.survive/60),l=h+"m "+(e.survive-60*h)+"s";r.textContent="Survive: "+l,i.gameOverMenu.stats.appendChild(n),i.gameOverMenu.stats.appendChild(a),i.gameOverMenu.stats.appendChild(o),t||i.gameOverMenu.stats.appendChild(r)},2e3)}}class S{constructor(e){this.blocks=[],this.terrain=[],this.impassableRoundObstacles=[],this.bushes=[],this.trees=[],this.rocks=[],this.rectangleObstacles=[],this.waterTerrainData=e}reset(){this.blocks.splice(0,this.blocks.length),this.terrain.splice(0,this.terrain.length),this.impassableRoundObstacles.splice(0,this.impassableRoundObstacles.length),this.bushes.splice(0,this.bushes.length),this.trees.splice(0,this.trees.length),this.rocks.splice(0,this.rocks.length),this.rectangleObstacles.splice(0,this.rectangleObstacles.length)}getSize(){return this.size}getBlockSize(){return this.blockSize}openMap(e){this.size=e.size*e.blockSize,this.blockSize=e.blockSize;for(let t=0;t<e.size;t++)for(let s=0;s<e.size;s++)this.blocks.push({x:s*e.blockSize,y:t*e.blockSize});for(const t of e.terrains)this.terrain.push(new o(t.type,t.x,t.y,t.size));let t=0;for(const s of e.rocks){const e=new c(t++,s.x,s.y);this.rocks.push(e),this.impassableRoundObstacles.push(e)}for(const s of e.bushes)this.bushes.push(new m(t++,s.x,s.y));for(const s of e.trees){const e=new l(t++,s.x,s.y);this.trees.push(e),this.impassableRoundObstacles.push(e)}for(const s of e.rects)this.rectangleObstacles.push(new d(t++,s.x,s.y,s.width,s.height))}}class f{constructor(){this.waterTriangle1=[],this.waterTriangle2=[],this.waterTriangle3=[],this.waterTriangle4=[]}setData(e,t){switch(e){case n.WaterTriangle1:this.waterTriangle1=t;break;case n.WaterTriangle2:this.waterTriangle2=t;break;case n.WaterTriangle3:this.waterTriangle3=t;break;case n.WaterTriangle4:this.waterTriangle4=t;break;default:throw new Error("Unknown water type")}}includeWater(e,t,s){let i,a=!1;switch(e){case n.WaterTriangle1:i=this.waterTriangle1;break;case n.WaterTriangle2:i=this.waterTriangle2;break;case n.WaterTriangle3:i=this.waterTriangle3;break;case n.WaterTriangle4:i=this.waterTriangle4;break;default:throw new Error("Unknown water type")}if(t<i.length&&s<i[t].length)i[t][s]&&(a=!0);else{if(0!==i.length)throw new Error("Out of range on water type");a=!0}return a}}class k{constructor(){this.body=[],this.hand=[],this.hammer=[],this.ready=!1}setData(e,t,s){this.body=e,this.hand=t,this.hammer=s,this.ready=!0}isReady(){return this.ready}}class M{constructor(e,t,s){this.x=e,this.y=t,this.size=s,this.radius=s/2}setX(e){this.x=e}setY(e){this.y=e}getX(){return this.x}getY(){return this.y}getCenterX(){return this.x+this.radius}getCenterY(){return this.y+this.radius}}class v{constructor(){this.size=8,this.timer=0,this.timerMax=60,this.x=-1*Math.round(30*Math.random()),this.y=Math.round(30*Math.random())}shift(){this.x+=.7,this.y-=.7,this.timer++}getX(){return this.x}getY(){return this.y}getTimer(){return this.timer}}class I{constructor(e){this.live=!0,this.hands=[],this.bloods=[],this.id=e.i,this.x=e.x,this.y=e.y,this.angle=e.a,this.hammerAngle=e.m,this.weapon=e.w,this.size=e.size,this.radius=this.size/2,this.hands.push(new M(e.lX,e.lY,e.hSize)),this.hands.push(new M(e.rX,e.rY,e.hSize))}createInjury(e){for(let t=0;t<e/2;t++)this.bloods.push(new v)}die(){this.live=!1}alive(){return this.live}setX(e){this.x=e}setY(e){this.y=e}setAngle(e){this.angle=e}setHammerAngle(e){this.hammerAngle=e}setWeapon(e){this.weapon=e}getX(){return this.x}getY(){return this.y}getAngle(){return this.angle}getHammerAngle(){return this.hammerAngle}getWeapon(){return this.weapon}getCenterX(){return this.x+this.radius}getCenterY(){return this.y+this.radius}}class x{constructor(e,t,s){this.centerX=e,this.centerY=t,this.radius=s}setCenterX(e){this.centerX=e}setCenterY(e){this.centerY=e}setRadius(e){this.radius=e}getCenterX(){return this.centerX}getCenterY(){return this.centerY}getRadius(){return this.radius}}class z{constructor(){this.innerCircle=new x(0,0,0),this.outerCircle=new x(0,0,0)}}class E{constructor(e,t){this.time=e,this.text=t}}class T{constructor(e,t){this.snapshots=[],this.messages=[],this.players=[],this.newerExists=!1,this.olderExists=!1,this.sumaNewer=0,this.averageSumaNewer=[],this.serverClientSync=e,this.zone=new z,this.map=t}addSumaNewer(e){if(this.averageSumaNewer.push(e),this.averageSumaNewer.length>100){this.averageSumaNewer.splice(0,1);let e=0;for(const t of this.averageSumaNewer)e+=t;console.log("averageSumaNewer: ",e/100)}}reset(){this.snapshots.splice(0,this.snapshots.length),this.betweenSnapshot=null,this.players.splice(0,this.players.length)}messageManager(){for(let e=this.messages.length-1;e>=0;e--){this.messages[e].time+5e3<Date.now()&&this.messages.splice(e,1)}if(this.messages.length>5){const e=this.messages.length-5;this.messages.splice(0,e)}}addSnapshot(e){0===this.snapshots.length&&(this.numberOfPlayers=e.p.length);let t=this.serverClientSync.getDrawDelay()-(this.serverClientSync.getServerTime()-e.t);if(t<0&&(t=0),e.p)for(const s of e.p)s.d&&setTimeout(()=>{for(const e of this.players)if(e.id===s.i){e.createInjury(s.d);break}},t);if(this.snapshots.push(e),this.snapshots.length>1&&this.completeSnapshot(this.snapshots[this.snapshots.length-2],e),e.m)for(const s of e.m)setTimeout(()=>{this.messages.push(new E(Date.now(),s))},t);this.updateMap(e,t),this.snapshots.length>50&&this.snapshots.splice(0,1)}updateMap(e,t){const s=e.o;for(const e of s)switch(e.t){case"w":for(const s of this.map.rectangleObstacles)if(s.id===e.i){setTimeout(()=>{s.update(e.o)},t);break}break;case"r":for(const s of this.map.rocks)if(s.id===e.i){setTimeout(()=>{s.update(e.o)},t);break}break;case"t":for(const s of this.map.trees)if(s.id===e.i){setTimeout(()=>{s.update(e.o)},t);break}break;case"b":for(const s of this.map.bushes)if(s.id===e.i){setTimeout(()=>{s.update(e.o)},t);break}}}updateZone(){if(!this.betweenSnapshot)return;const e=this.betweenSnapshot.z;this.zone.innerCircle.setRadius(e.iR),this.zone.innerCircle.setCenterX(e.iX),this.zone.innerCircle.setCenterY(e.iY),this.zone.outerCircle.setRadius(e.oR),this.zone.outerCircle.setCenterX(e.oX),this.zone.outerCircle.setCenterY(e.oY)}completeSnapshot(e,t){this.completePlayerSnapshots(e.p,t.p),this.completeMyPlayerSnapshot(e.i,t.i),this.completeLootSnapshots(e.l,t.l),this.completeZoneSnapshot(e.z,t.z),t.z.hasOwnProperty("d")||(t.z.d=e.z.d)}completeMyPlayerSnapshot(e,t){t.hasOwnProperty("h")||(t.h=e.h),t.hasOwnProperty("i1")||(t.i1=e.i1),t.hasOwnProperty("i2")||(t.i2=e.i2),t.hasOwnProperty("i3")||(t.i3=e.i3),t.hasOwnProperty("i4")||(t.i4=e.i4),t.hasOwnProperty("i5")||(t.i5=e.i5),t.hasOwnProperty("s4")||(t.s4=e.s4),t.hasOwnProperty("s5")||(t.s5=e.s5),t.hasOwnProperty("a")||(t.a=e.a),t.hasOwnProperty("aM")||(t.aM=e.aM),t.hasOwnProperty("r")||(t.r=e.r),t.hasOwnProperty("g")||(t.g=e.g),t.hasOwnProperty("b")||(t.b=e.b),t.hasOwnProperty("o")||(t.o=e.o),t.hasOwnProperty("s")||(t.s=e.s),t.hasOwnProperty("v")||(t.v=e.v),t.hasOwnProperty("l")||(t.l=e.l),t.hasOwnProperty("lE")||(t.lE=e.lE),t.hasOwnProperty("lT")||(t.lT=e.lT),t.hasOwnProperty("spectate")||(t.spectate=e.spectate),t.hasOwnProperty("spectateName")||(t.spectateName=e.spectateName),t.hasOwnProperty("ai")||(t.ai=e.ai)}completeZoneSnapshot(e,t){t.hasOwnProperty("iX")||(t.iX=e.iX),t.hasOwnProperty("iY")||(t.iY=e.iY),t.hasOwnProperty("iR")||(t.iR=e.iR),t.hasOwnProperty("oX")||(t.oX=e.oX),t.hasOwnProperty("oY")||(t.oY=e.oY),t.hasOwnProperty("oR")||(t.oR=e.oR)}completeLootSnapshots(e,t){for(const s of t){let t;for(const i of e)i.i===s.i&&(t=i);t&&(s.hasOwnProperty("size")||(s.size=t.size),s.hasOwnProperty("type")||(s.type=t.type),s.hasOwnProperty("x")||(s.x=t.x),s.hasOwnProperty("y")||(s.y=t.y),!s.hasOwnProperty("quantity")&&t.hasOwnProperty("quantity")&&(s.quantity=t.quantity))}const s=[];for(const i of e){let e=!1;for(const s of t)if(i.i===s.i){e=!0;break}e||s.push(i)}for(const e of s)t.push(e);for(let e=t.length-1;e>=0;e--)t[e].hasOwnProperty("del")&&t.splice(e,1)}completePlayerSnapshots(e,t){for(const s of t){let t;for(const i of e)i.i===s.i&&(t=i);t&&(s.hasOwnProperty("a")||(s.a=t.a),s.hasOwnProperty("m")||(s.m=t.m),s.hasOwnProperty("size")||(s.size=t.size),s.hasOwnProperty("w")||(s.w=t.w),s.hasOwnProperty("x")||(s.x=t.x),s.hasOwnProperty("y")||(s.y=t.y),s.hasOwnProperty("l")||(s.l=t.l),s.hasOwnProperty("hSize")||(s.hSize=t.hSize),s.hasOwnProperty("lX")||(s.lX=t.lX),s.hasOwnProperty("lY")||(s.lY=t.lY),s.hasOwnProperty("rX")||(s.rX=t.rX),s.hasOwnProperty("rY")||(s.rY=t.rY))}const s=[];for(const i of e){let e=!1;for(const s of t)if(i.i===s.i){e=!0;break}e||s.push(i.i)}for(const i of s)for(const s of e)if(i===s.i){t.push(s);break}t.sort((e,t)=>e.i-t.i)}createBetweenSnapshot(){if(this.snapshots.length&&this.serverClientSync.ready()){let e,t,s=0;this.sumaNewer=0,this.newerExists=!1,this.olderExists=!1;const i=this.serverClientSync.getServerTime()-this.serverClientSync.getDrawDelay();for(const e of this.snapshots)e.t<=i&&(t=e,this.olderExists=!0);for(const t of this.snapshots)t.t>=i&&(e||(e=t,this.newerExists=!0),this.sumaNewer++);if(e||(e=t,this.serverClientSync.reset()),this.sumaNewer>12&&this.serverClientSync.changeDrawDelay(-5),this.sumaNewer>11&&this.serverClientSync.changeDrawDelay(-4),this.sumaNewer>10&&this.serverClientSync.changeDrawDelay(-3),this.sumaNewer>9?this.serverClientSync.changeDrawDelay(-1):this.sumaNewer>8?this.serverClientSync.changeDrawDelay(-.5):this.sumaNewer>7?this.serverClientSync.changeDrawDelay(-.2):this.sumaNewer>6?this.serverClientSync.changeDrawDelay(-.1):this.sumaNewer<6?this.serverClientSync.changeDrawDelay(.1):this.sumaNewer<5?this.serverClientSync.changeDrawDelay(.2):this.sumaNewer<4?this.serverClientSync.changeDrawDelay(.5):this.sumaNewer<3?this.serverClientSync.changeDrawDelay(1):this.sumaNewer<2?this.serverClientSync.changeDrawDelay(2):this.sumaNewer<1&&this.serverClientSync.changeDrawDelay(3),this.addSumaNewer(this.sumaNewer),t&&e){const n=e.t-t.t,a=i-t.t;n&&(s=a/n);const o=e;this.betweenSnapshot={t:o.t,i:Object.assign({},o.i),p:[],b:[],g:[],s:[],z:Object.assign({},o.z),l:[],o:[]};for(const e of o.p)this.betweenSnapshot.p.push(Object.assign({},e));for(const e of o.b)this.betweenSnapshot.b.push(Object.assign({},e));for(const e of o.g)this.betweenSnapshot.g.push(Object.assign({},e));for(const e of o.s)this.betweenSnapshot.s.push(Object.assign({},e));for(const e of o.l)this.betweenSnapshot.l.push(Object.assign({},e));for(let i=0;i<this.betweenSnapshot.p.length;i++){const n=this.betweenSnapshot.p[i];n.x=this.positionBetweenSnapshots(t.p[i].x,e.p[i].x,s),n.y=this.positionBetweenSnapshots(t.p[i].y,e.p[i].y,s),n.h||(n.lX=this.positionBetweenSnapshots(t.p[i].lX,e.p[i].lX,s),n.lY=this.positionBetweenSnapshots(t.p[i].lY,e.p[i].lY,s),n.rX=this.positionBetweenSnapshots(t.p[i].rX,e.p[i].rX,s),n.rY=this.positionBetweenSnapshots(t.p[i].rY,e.p[i].rY,s))}for(const i of this.betweenSnapshot.l){let n,a;for(const e of t.l)if(i.i===e.i){n=e;break}for(const t of e.l)if(i.i===t.i){a=t;break}n&&a&&(i.x=this.positionBetweenSnapshots(n.x,a.x,s),i.y=this.positionBetweenSnapshots(n.y,a.y,s))}this.betweenSnapshot.z.oR=this.positionBetweenSnapshots(t.z.oR,e.z.oR,s),this.betweenSnapshot.z.oX=this.positionBetweenSnapshots(t.z.oX,e.z.oX,s),this.betweenSnapshot.z.oY=this.positionBetweenSnapshots(t.z.oY,e.z.oY,s)}}this.updatePlayers(),this.updateZone()}updatePlayers(){if(this.betweenSnapshot)for(const e of this.betweenSnapshot.p){let t=!1;for(const s of this.players)if(s.id===e.i){s.setX(e.x),s.setY(e.y),s.setAngle(e.a),s.setWeapon(e.w),s.setHammerAngle(e.m),0===e.l&&s.die(),s.hands[0].setX(e.lX),s.hands[0].setY(e.lY),s.hands[1].setX(e.rX),s.hands[1].setY(e.rY),t=!0;break}t||this.players.push(new I(e))}}positionBetweenSnapshots(e,t,s){let i=1;return t<e&&(i=-1),e+Math.abs(t-e)*i*s}}class C{constructor(e,t,s,i,n,a){this.spectate=!1,this.gameRun=!1,this.gameId=-1,this.playerId=-1,this.socket=s,this.serverClientSync=i,this.waterTerrainData=new f,this.map=new S(this.waterTerrainData),this.snapshotManager=new T(i,this.map),this.keys=e,this.mouse=t,this.myHtmlElements=n,this.editor=a,this.collisionPoints=new k,this.view=new b(this.map,this.mouse,this.waterTerrainData,this.serverClientSync,this.myHtmlElements,this.collisionPoints,this.snapshotManager),setTimeout(()=>{this.loop()},200)}reset(){const e=this.myHtmlElements;e.close(e.gameOverMenu.main),e.open(e.mainMenu.main,e.hideGame),e.gameOverMenu.stats.innerHTML="",this.gameRun=!1,this.gameId=-1,this.playerId=-1,this.map.reset(),this.snapshotManager.reset(),this.view.reset(),this.spectate=!1}stop(){this.gameRun=!1}isNameOk(e){let t=!1;if("string"==typeof e&&e.length>0&&e.length<=20){let s=!1;for(let t=0;t<e.length;t++)if(-1==="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ".lastIndexOf(e[t])){s=!0;break}s||(t=!0)}return t}startSpectate(){this.spectate=!0}getSpectate(){return this.spectate}setName(e){this.name=e}getName(){return this.name}getGameId(){return this.gameId}setGameId(e){this.gameId=e}getPlayerId(){return this.playerId}setPlayerId(e){this.playerId=e,console.log("playerId:",e)}gameStart(){this.gameRun=!0}gameActive(){return this.gameRun}loop(){requestAnimationFrame(()=>{this.loop()}),this.editor.isActive()&&this.view.drawEditor(this.editor),this.gameRun&&(this.serverClientSync.ready()||this.socket.emit("serverClientSync",Date.now()),this.snapshotManager.createBetweenSnapshot(),this.view.drawGame(this.playerId))}}class G{constructor(){this.ping=0,this.pings=[],this.timeDiference=0,this.timeDiferences=[],this.attempts=3,this.defaultDrawDelay=100,this.drawDelay=this.defaultDrawDelay}getPing(){return this.ping}getTimeDiference(){return this.timeDiference}ready(){return this.pings.length===this.attempts}reset(){this.pings=[],this.timeDiferences=[]}addData(e,t){if(this.ready()||(this.pings.push(e),this.timeDiferences.push(t)),this.pings.length===this.attempts){let e=0;for(const t of this.pings)e+=t;this.ping=e/this.attempts;let t=0;for(const e of this.timeDiferences)t+=e;this.timeDiference=t/this.attempts}}changeDrawDelay(e){this.drawDelay+=e}getDrawDelay(){return this.drawDelay}getServerTime(){let e=Date.now();return this.ready()&&(e+=this.getTimeDiference()),e}}class P{constructor(){this.healthBar={main:document.getElementById("healthBar"),in:document.getElementById("healthBarIn")},this.items={redAmmo:document.getElementById("redAmmo"),greenAmmo:document.getElementById("greenAmmo"),blueAmmo:document.getElementById("blueAmmo"),orangeAmmo:document.getElementById("orangeAmmo"),item1:document.getElementById("item1"),item2:document.getElementById("item2"),item3:document.getElementById("item3"),item4:document.getElementById("item4"),item5:document.getElementById("item5"),item1in:document.getElementById("item1").getElementsByTagName("span")[0],item2in:document.getElementById("item2").getElementsByTagName("span")[0],item3in:document.getElementById("item3").getElementsByTagName("span")[0],item4in:document.getElementById("item4").getElementsByTagName("span")[0],item5in:document.getElementById("item5").getElementsByTagName("span")[0],item1Ammo:document.getElementById("item1Ammo"),item2Ammo:document.getElementById("item2Ammo"),scope:document.getElementById("scope"),scope2:document.getElementById("scope2"),scope4:document.getElementById("scope4"),scope6:document.getElementById("scope6"),scopeSVG:document.getElementById("scope").getElementsByTagName("img")[0],vest:document.getElementById("vest")},this.editor={coordinates:document.getElementById("editorCoordinates"),container:document.getElementById("editorContainer"),screen:document.getElementById("editorScreen"),terrainImgs:document.getElementById("editorTerrainImgs"),terrainWater:document.getElementById("terrainWater"),terrainGrass:document.getElementById("terrainGrass"),terrainWaterTriangle1:document.getElementById("terrainWaterTriangle1"),terrainWaterTriangle2:document.getElementById("terrainWaterTriangle2"),terrainWaterTriangle3:document.getElementById("terrainWaterTriangle3"),terrainWaterTriangle4:document.getElementById("terrainWaterTriangle4"),objectImgs:document.getElementById("editorObjectImgs"),objectBush:document.getElementById("editorObjectBush"),objectRock:document.getElementById("editorObjectRock"),objectTree:document.getElementById("editorObjectTree"),objectRect:document.getElementById("editorObjectRect"),objectDelete:document.getElementById("editorObjectDelete"),openMenu:document.getElementById("editorOpenMenu")},this.saveMapMenu={main:document.getElementById("saveMapMenu"),back:document.getElementById("saveMapMenuBack")},this.gameOverMenu={main:document.getElementById("gameOverMenu"),back:document.getElementById("gameOverMenuBack"),h1:document.getElementById("gameOverMenuH1"),stats:document.getElementById("gameOverMenuStats"),spectate:document.getElementById("gameOverMenuspectate")},this.mapEditorMenu={main:document.getElementById("mapEditorMenu"),name:document.getElementById("mapEditorMenuName"),save:document.getElementById("mapEditorMenuSave"),changeSize:document.getElementById("mapEditorMenuChangeSize"),back:document.getElementById("mapEditorMenuBack"),close:document.getElementById("mapEditorMenuClose")},this.alertMenu={main:document.getElementById("alertMenu"),ok:document.getElementById("alertMenuOk")},this.openMapMenu={main:document.getElementById("openMapMenu"),maps:document.getElementById("openMapMenuMaps"),ok:document.getElementById("openMapMenuOk"),back:document.getElementById("openMapMenuBack")},this.controlsMenu={main:document.getElementById("controlsMenu"),back:document.getElementById("controlsMenuBack")},this.mainMenu={main:document.getElementById("mainMenu"),ip:document.getElementById("mainMenuIp"),name:document.getElementById("mainMenuName"),games:document.getElementById("mainMenuGames"),join:document.getElementById("mainMenuJoin"),maps:document.getElementById("mainMenuMaps"),create:document.getElementById("mainMenuCreate"),openEditor:document.getElementById("mainMenuOpenEditor"),controls:document.getElementById("mainMenuControls")},this.gameCanceledMenu={main:document.getElementById("cancelLobbyMenu"),back:document.getElementById("cancelLobbyMenuBack")},this.mapSizeMenu={main:document.getElementById("mapSizeMenu"),value:document.getElementById("mapSizeValue"),ok:document.getElementById("mapSizeOk"),back:document.getElementById("mapSizeBack")},this.mapMenu={main:document.getElementById("mapMenu"),create:document.getElementById("mapMenuCreate"),open:document.getElementById("mapMenuOpenMap"),back:document.getElementById("mapMenuBack")},this.lobbyMenu={main:document.getElementById("lobbyMenu"),gameName:document.getElementById("lobbyMenuGameName"),players:document.getElementById("lobbyMenuPlayers"),forJoinPlayers:document.getElementById("lobbyMenuForJoinPlayer"),leave:document.getElementById("lobbyMenuLeave"),forCreatePlayer:document.getElementById("lobbyMenuForCreatePlayer"),start:document.getElementById("lobbyMenuStart"),cancel:document.getElementById("lobbyMenuCancel")},this.loading={main:document.getElementById("loading"),counter:document.getElementById("loadingCounter"),circle:document.getElementById("loadingCircle"),text:document.getElementById("loadingText")},this.escFromGameMenu={main:document.getElementById("escFromGame"),back:document.getElementById("escFromGameBack"),leave:document.getElementById("escFromGameLeave")},this.gameScreen=document.getElementById("gameScreen"),this.mapScreen=document.getElementById("mapScreen"),this.helperScreen=document.getElementById("helperScreen"),this.zoneSVG=document.getElementById("zoneSVG"),this.zoneCircle=document.getElementById("zoneCircle"),this.zoneRect=document.getElementById("zoneRect"),this.mapZoneSVG=document.getElementById("mapZoneSVG"),this.mapZoneCircle=document.getElementById("mapZoneCircle"),this.takeLoot=document.getElementById("takeLoot"),this.transparentLayer=document.getElementById("transparentLayer"),this.activeGunAmmo=document.getElementById("activeGunAmmo"),this.mapContainer=document.getElementById("mapContainer"),this.alive=document.getElementById("alive"),this.messages=document.getElementById("messages"),this.zoneTimer=document.getElementById("zoneTimer"),this.spectate=document.getElementById("spectate"),this.spectateName=document.getElementById("spectateName"),this.hideGame=document.getElementById("hideGame")}close(...e){for(const t of e)t.style.display="none"}open(...e){for(const t of e)t.style.display="block"}}class A{constructor(e,t,s,i,n,a,o){this.size=e,this.blockSize=t,this.terrains=s,this.rects=i,this.bushes=n,this.rocks=a,this.trees=o}}class O{constructor(e,t){this.active=!1,this.blockSize=300,this.terrains=[],this.bushes=[],this.rocks=[],this.trees=[],this.walls=[],this.objects=[],this.myHtmlElements=e,this.socket=t,this.colors=new p,this.bush=new m(0,0,0),this.rock=new c(0,0,0),this.tree=new l(0,0,0),this.controller()}isActive(){return this.active}close(){this.active=!1}getTerrainType(){return this.terrainType}getObjectType(){return this.objectType}getSize(){return this.size}getX(){return this.x}getY(){return this.y}getMapData(){return new A(this.size,this.blockSize,this.terrains,this.walls,this.bushes,this.rocks,this.trees)}create(){this.cleanMap()}changeSize(e){this.active=!0;const t=this.myHtmlElements;this.size=e,t.editor.screen.width=e*this.blockSize,t.editor.screen.height=e*this.blockSize;const s=(e*this.blockSize).toString();t.editor.screen.style.width=s;const i=(e*this.blockSize).toString();t.editor.screen.style.width=i,this.cleanMapAfterChangeSize()}cleanMap(){this.terrains=[],this.bushes=[],this.rocks=[],this.trees=[],this.walls=[]}cleanMapAfterChangeSize(){const e=this.size*this.blockSize;let t=this.terrains;for(let s=t.length-1;s>=0;s--){const i=t[s];(i.x>=e||i.y>=e)&&t.splice(s,1)}for(let s=(t=this.trees).length-1;s>=0;s--){const i=t[s];(i.x>=e||i.y>=e)&&t.splice(s,1)}for(let s=(t=this.rocks).length-1;s>=0;s--){const i=t[s];(i.x>=e||i.y>=e)&&t.splice(s,1)}for(let s=(t=this.bushes).length-1;s>=0;s--){const i=t[s];(i.x>=e||i.y>=e)&&t.splice(s,1)}for(let s=(t=this.walls).length-1;s>=0;s--){const i=t[s];(i.x>=e||i.y>=e)&&t.splice(s,1)}}openMap(e){this.create(),this.changeSize(e.size);let t=0;for(const s of e.rocks)this.rocks.push(new c(t++,s.x,s.y));for(const s of e.trees)this.trees.push(new l(t++,s.x,s.y));for(const s of e.bushes)this.bushes.push(new m(t++,s.x,s.y));for(const s of e.rects)this.walls.push(new d(t++,s.x,s.y,s.width,s.height));for(const t of e.terrains)this.terrains.push(new o(t.type,t.x,t.y,t.size));this.cleanMapAfterChangeSize()}controller(){const e=this.myHtmlElements;e.editor.screen.addEventListener("mousemove",t=>{const s=e.editor.screen.getBoundingClientRect();this.x=t.clientX+e.editor.screen.scrollLeft-s.left,this.y=t.clientY+e.editor.screen.scrollTop-s.top,e.editor.coordinates.innerText=`x: ${this.x} y: ${this.y}`}),e.editor.terrainImgs.addEventListener("click",t=>{const s=e.editor.terrainImgs.children;for(let e=0;e<s.length;e++)s[e].style.borderColor=this.colors.blockFrame;const i=e.editor.objectImgs.children;for(let e=0;e<i.length;e++)i[e].style.borderColor=this.colors.blockFrame;switch(t.target.style.borderColor=this.colors.blockFrameActive,this.objectType=null,t.target){case e.editor.terrainWater:this.terrainType=n.Water;break;case e.editor.terrainGrass:this.terrainType=n.Grass;break;case e.editor.terrainWaterTriangle1:this.terrainType=n.WaterTriangle1;break;case e.editor.terrainWaterTriangle2:this.terrainType=n.WaterTriangle2;break;case e.editor.terrainWaterTriangle3:this.terrainType=n.WaterTriangle3;break;case e.editor.terrainWaterTriangle4:this.terrainType=n.WaterTriangle4}}),e.editor.objectImgs.addEventListener("click",t=>{const s=e.editor.terrainImgs.children;for(let e=0;e<s.length;e++)s[e].style.borderColor=this.colors.blockFrame;const i=e.editor.objectImgs.children;for(let e=0;e<i.length;e++)i[e].style.borderColor=this.colors.blockFrame;switch(t.target.style.borderColor=this.colors.blockFrameActive,this.terrainType=null,t.target){case e.editor.objectBush:this.objectType="bush";break;case e.editor.objectRock:this.objectType="rock";break;case e.editor.objectTree:this.objectType="tree";break;case e.editor.objectRect:this.objectType="rect";break;case e.editor.objectDelete:this.objectType="delete"}}),e.editor.screen.addEventListener("click",()=>{if(null!=this.getTerrainType()){const e=Math.floor(this.getX()/this.blockSize)*this.blockSize,t=Math.floor(this.getY()/this.blockSize)*this.blockSize;let s=-1;for(let i=0;i<this.terrains.length;i++){const n=this.terrains[i];if(n.x===e&&n.y===t){s=i;break}}-1!==s&&this.terrains.splice(s,1),this.getTerrainType()!==n.Grass&&this.terrains.push(new o(this.getTerrainType(),e,t,this.blockSize))}if(null!=this.getObjectType())switch(this.getObjectType()){case"bush":this.bushes.push(new m(0,this.x-this.bush.size/2,this.y-this.bush.size/2));break;case"rock":this.rocks.push(new c(0,this.x-this.rock.size/2,this.y-this.rock.size/2));break;case"tree":this.trees.push(new l(0,this.x-this.tree.size/2,this.y-this.tree.size/2));break;case"rect":this.walls.push(new d(0,this.x-this.bush.size/2,this.y-this.bush.size/2,this.bush.size,this.bush.size));break;case"delete":let e;const t=this;for(const s of t.rocks){const i=s;i.x<=t.getX()&&i.x+i.size>=t.getX()&&i.y<=t.getY()&&i.y+i.size>=t.getY()&&(e=i)}for(const s of t.walls){const i=s;i.x<=t.getX()&&i.x+i.width>=t.getX()&&i.y<=t.getY()&&i.y+i.height>=t.getY()&&(e=i)}for(const s of t.bushes){const i=s;i.x<=t.getX()&&i.x+i.size>=t.getX()&&i.y<=t.getY()&&i.y+i.size>=t.getY()&&(e=i)}for(const s of t.trees){const i=s;i.x<=t.getX()&&i.x+i.size>=t.getX()&&i.y<=t.getY()&&i.y+i.size>=t.getY()&&(e=i)}let s=-1;for(let t=0;t<this.rocks.length;t++)e==this.rocks[t]&&(s=t);-1!==s&&(this.rocks.splice(s,1),s=-1);for(let t=0;t<this.bushes.length;t++)e==this.bushes[t]&&(s=t);-1!==s&&(this.bushes.splice(s,1),s=-1);for(let t=0;t<this.trees.length;t++)e==this.trees[t]&&(s=t);-1!==s&&(this.trees.splice(s,1),s=-1);for(let t=0;t<this.walls.length;t++)e==this.walls[t]&&(s=t);-1!==s&&(this.walls.splice(s,1),s=-1)}}),this.socket.on("openMapInEditor",t=>{this.openMap(t),e.close(e.openMapMenu.main),e.open(e.editor.container)})}}class B{constructor(){this.keys={w:!1,a:!1,s:!1,d:!1,e:!1,r:!1},this.mouse={x:0,y:0,left:!1,middle:!1,right:!1},this.playerAngle=0,this.myHtmlElements=new P,this.canvas=document.getElementsByTagName("canvas")[0],this.socket=io.connect("http://192.168.0.2:8080"),this.serverClientSync=new G,this.editor=new O(this.myHtmlElements,this.socket),this.model=new C(this.keys,this.mouse,this.socket,this.serverClientSync,this.myHtmlElements,this.editor),window.addEventListener("resize",()=>{this.model.view.screenResize();const e=new Event("mousemove");this.canvas.dispatchEvent(e)}),window.addEventListener("beforeunload",e=>{e.preventDefault(),e.returnValue=""}),this.keysController(),this.mouseController(),this.socketController(),this.menuController()}static run(){if(B.instance)throw new Error("Only one controller!");B.instance=new B}changePlayerName(){const e=this.myHtmlElements;let t=!1;e.mainMenu.name.value.length&&(t=!0,localStorage.setItem("playerName",e.mainMenu.name.value)),e.mainMenu.create.disabled=!t,e.mainMenu.maps.disabled=!t;let s=!1;e.mainMenu.games.value&&(s=!0);let i=!0;t&&s&&(i=!1),e.mainMenu.join.disabled=i,e.mainMenu.games.disabled=i}socketController(){const e=this.myHtmlElements;this.socket.on("winner",e=>{this.model.view.gameOver(e,!0)}),this.socket.on("loser",e=>{this.model.view.gameOver(e,!1)}),this.socket.on("stopGame",()=>{this.model.stop()}),this.socket.on("stopSpectate",(e,t)=>{this.model.view.gameOver(e,!0,t)}),this.socket.on("startGame",t=>{this.model.map.openMap(t),this.model.gameStart(),e.close(e.lobbyMenu.main),setTimeout(()=>{e.close(e.hideGame)},100)}),this.socket.on("playerId",e=>{this.model.setPlayerId(e)}),this.socket.on("createGame",(t,s)=>{this.model.setGameId(t),e.close(e.mainMenu.main,e.lobbyMenu.forJoinPlayers),e.open(e.lobbyMenu.main,e.lobbyMenu.forCreatePlayer)}),this.socket.on("joinGame",(t,s)=>{this.model.setGameId(t),e.close(e.mainMenu.main,e.lobbyMenu.forCreatePlayer),e.open(e.lobbyMenu.main,e.lobbyMenu.forJoinPlayers)}),this.socket.on("leaveLobby",()=>{this.model.setGameId(-1),e.close(e.lobbyMenu.main),e.open(e.mainMenu.main)}),this.socket.on("cancelLobby",()=>{this.model.setGameId(-1),e.close(e.lobbyMenu.main),e.open(e.gameCanceledMenu.main)}),this.socket.on("updateListOpenGames",t=>{e.mainMenu.games.innerHTML="";for(const s of t){const t=document.createElement("option");t.textContent=s.name+"'s game",t.setAttribute("value",s.index.toString()),e.mainMenu.games.appendChild(t)}t.length&&e.mainMenu.name.value.length?(e.mainMenu.games.disabled=!1,e.mainMenu.join.disabled=!1):(e.mainMenu.games.disabled=!0,e.mainMenu.join.disabled=!0)}),this.socket.on("listOfPlayers",t=>{e.lobbyMenu.gameName.textContent=t[0]+"'s game",e.lobbyMenu.players.innerHTML="";for(const s of t){const t=document.createElement("li");t.textContent=s,e.lobbyMenu.players.appendChild(t)}}),this.socket.on("collisionPoints",(e,t,s)=>{this.model.collisionPoints.setData(e,t,s)}),this.socket.on("sendMap",e=>{this.model.map.openMap(e)}),this.socket.on("mapSaved",()=>{e.close(e.mapEditorMenu.main,e.editor.container),e.open(e.saveMapMenu.main),this.editor.close()}),this.socket.on("listOfMaps",t=>{e.openMapMenu.maps.innerHTML="",e.mainMenu.maps.innerHTML="";for(const s of t){const t=document.createElement("option");t.setAttribute("value",s),t.textContent=s,e.mainMenu.maps.appendChild(t);const i=t.cloneNode(!0);e.openMapMenu.maps.appendChild(i)}}),this.socket.on("createPlayer",e=>{e?this.model.setName(e):console.log("error created player")}),this.socket.on("serverClientSync",(e,t)=>{const s=Date.now(),i=s-e,n=t-(s-i/2);this.serverClientSync.addData(i,n)}),this.socket.on("u",e=>{this.model.snapshotManager.addSnapshot(e)})}mouseController(){document.addEventListener("contextmenu",(function(e){e.preventDefault()})),document.addEventListener("mousedown",(function(e){2===e.which&&e.preventDefault()})),this.myHtmlElements.transparentLayer.addEventListener("mousemove",e=>{if(!this.model.gameActive())return;null==e.x?(this.mouse.x=this.canvas.width/2,this.mouse.y=this.canvas.height/2):(this.mouse.x=e.x,this.mouse.y=e.y);const t=this.playerAngle;this.rotatePlayer(this.mouse.x,this.mouse.y),this.playerAngle!==t&&this.socket.emit("a",this.model.getGameId(),this.playerAngle)}),this.myHtmlElements.transparentLayer.addEventListener("mousedown",e=>{if(!this.model.gameActive())return;this.mouse.left=!0;const t=new r(e.clientX,e.clientY),s=this.model.view.calculateServerPosition(t);this.socket.emit("m",this.model.getGameId(),"l",s)}),this.myHtmlElements.transparentLayer.addEventListener("mouseup",e=>{this.model.gameActive()&&(this.mouse.left=!1,this.socket.emit("m",this.model.getGameId(),"-l"))})}rotatePlayer(e,t){const s=this.canvas.width/2,i=this.canvas.height/2;let n=s-e,a=i-t;0===n&&(n=.1);let o=Math.abs(180*Math.atan(n/a)/Math.PI);e>=s&&t<i&&(this.playerAngle=o),e>=s&&t>=i&&(this.playerAngle=180-o),e<s&&t>=i&&(this.playerAngle=180+o),e<s&&t<i&&(this.playerAngle=360-o),this.playerAngle=Math.round(this.playerAngle),360===this.playerAngle&&(this.playerAngle=0)}keysController(){document.addEventListener("keydown",e=>{if("Escape"===e.code&&(this.model.gameActive()||this.model.getSpectate())&&(this.myHtmlElements.escFromGameMenu.main.style.display="block"),this.model.gameActive())switch(e.code){case"KeyW":this.keys.w||this.socket.emit("c",this.model.getGameId(),"u"),this.keys.w=!0;break;case"KeyA":this.keys.a||this.socket.emit("c",this.model.getGameId(),"l"),this.keys.a=!0;break;case"KeyS":this.keys.s||this.socket.emit("c",this.model.getGameId(),"d"),this.keys.s=!0;break;case"KeyD":this.keys.d||this.socket.emit("c",this.model.getGameId(),"r"),this.keys.d=!0;break;case"KeyE":this.keys.e||this.socket.emit("c",this.model.getGameId(),"e"),this.keys.e=!0;break;case"KeyR":this.keys.e||this.socket.emit("c",this.model.getGameId(),"re"),this.keys.r=!0;break;case"Digit0":this.socket.emit("i",this.model.getGameId(),0);break;case"Digit1":this.socket.emit("i",this.model.getGameId(),1);break;case"Digit2":this.socket.emit("i",this.model.getGameId(),2);break;case"Digit3":this.socket.emit("i",this.model.getGameId(),3);break;case"Digit4":this.socket.emit("i",this.model.getGameId(),4);break;case"Digit5":this.socket.emit("i",this.model.getGameId(),5);break;case"Digit6":this.socket.emit("i",this.model.getGameId(),6);break;case"Digit7":this.socket.emit("i",this.model.getGameId(),7);break;case"Digit8":this.socket.emit("i",this.model.getGameId(),8)}}),document.addEventListener("keyup",e=>{if(this.model.gameActive())switch(e.code){case"KeyW":this.keys.w&&this.socket.emit("c",this.model.getGameId(),"-u"),this.keys.w=!1;break;case"KeyA":this.keys.a&&this.socket.emit("c",this.model.getGameId(),"-l"),this.keys.a=!1;break;case"KeyS":this.keys.s&&this.socket.emit("c",this.model.getGameId(),"-d"),this.keys.s=!1;break;case"KeyD":this.keys.d&&this.socket.emit("c",this.model.getGameId(),"-r"),this.keys.d=!1;break;case"KeyE":this.keys.e=!1;break;case"KeyR":this.keys.r=!1}})}menuController(){const e=this.myHtmlElements;localStorage.getItem("playerName")&&(e.mainMenu.name.value=localStorage.getItem("playerName"),this.changePlayerName()),e.escFromGameMenu.back.addEventListener("click",()=>{e.escFromGameMenu.main.style.display="none"}),e.escFromGameMenu.leave.addEventListener("click",()=>{e.escFromGameMenu.main.style.display="none",this.socket.emit("leaveGame",this.model.getGameId()),this.model.reset()}),e.gameOverMenu.back.addEventListener("click",()=>{this.socket.emit("leaveGame",this.model.getGameId()),this.model.reset()}),e.gameOverMenu.spectate.addEventListener("click",()=>{this.socket.emit("spectate",this.model.getGameId()),e.close(e.gameOverMenu.main),this.model.startSpectate()}),e.mapSizeMenu.ok.addEventListener("click",()=>{this.editor.changeSize(parseInt(document.getElementById("mapSizeValue").value)),e.open(e.editor.container),e.close(e.mapSizeMenu.main)}),e.mapSizeMenu.back.addEventListener("click",()=>{e.close(e.mapSizeMenu.main),this.editor.isActive()?e.open(e.mapEditorMenu.main):e.open(e.mapMenu.main)}),e.mapMenu.create.addEventListener("click",()=>{this.editor.create(),e.close(e.mapMenu.main),e.open(e.mapSizeMenu.main)}),e.mapMenu.open.addEventListener("click",()=>{e.close(e.mapMenu.main),e.open(e.openMapMenu.main)}),e.mapMenu.back.addEventListener("click",()=>{e.close(e.mapMenu.main),e.open(e.mainMenu.main)}),e.openMapMenu.back.addEventListener("click",()=>{e.close(e.openMapMenu.main),e.open(e.mapMenu.main)}),e.openMapMenu.ok.addEventListener("click",()=>{const t=e.openMapMenu.maps.value;this.socket.emit("openMapInEditor",t)}),e.editor.openMenu.addEventListener("click",()=>{e.open(e.mapEditorMenu.main)}),e.mapEditorMenu.back.addEventListener("click",()=>{e.close(e.mapEditorMenu.main)}),e.mapEditorMenu.close.addEventListener("click",()=>{e.close(e.mapEditorMenu.main,e.editor.container),e.open(e.mainMenu.main),this.editor.close()}),e.mapEditorMenu.save.addEventListener("click",()=>{const t=this.editor.getMapData(),s=e.mapEditorMenu.name.value;this.model.isNameOk(s)?this.socket.emit("editorSaveMap",s,t):e.open(e.alertMenu.main)}),e.mapEditorMenu.changeSize.addEventListener("click",()=>{e.close(e.mapEditorMenu.main),e.open(e.mapSizeMenu.main)}),e.saveMapMenu.back.addEventListener("click",()=>{e.close(e.saveMapMenu.main),e.open(e.mainMenu.main)}),e.mainMenu.openEditor.addEventListener("click",()=>{e.open(e.mapMenu.main),e.close(e.mainMenu.main)}),e.mainMenu.name.addEventListener("input",()=>{this.changePlayerName()}),e.mainMenu.create.addEventListener("click",()=>{if(e.mainMenu.name.value.length){const t=e.mainMenu.name.value,s=e.mainMenu.maps.value;this.model.isNameOk(t)?this.socket.emit("createGame",t,s):e.open(e.alertMenu.main)}}),e.mainMenu.join.addEventListener("click",()=>{if(e.mainMenu.name.value.length&&e.mainMenu.games.value){const t=e.mainMenu.name.value,s=parseInt(e.mainMenu.games.value);this.model.isNameOk(t)?this.socket.emit("joinGame",t,s):e.open(e.alertMenu.main)}}),e.gameCanceledMenu.back.addEventListener("click",()=>{e.close(e.gameCanceledMenu.main),e.open(e.mainMenu.main)}),e.mainMenu.controls.addEventListener("click",()=>{e.open(e.controlsMenu.main),e.close(e.mainMenu.main)}),e.alertMenu.ok.addEventListener("click",()=>{e.close(e.alertMenu.main)}),e.lobbyMenu.leave.addEventListener("click",()=>{this.socket.emit("leaveLobby",this.model.getGameId())}),e.lobbyMenu.cancel.addEventListener("click",()=>{this.socket.emit("cancelLobby",this.model.getGameId())}),e.lobbyMenu.start.addEventListener("click",()=>{e.close(e.lobbyMenu.main),this.socket.emit("startGame",this.model.getGameId())}),e.controlsMenu.back.addEventListener("click",()=>{e.open(e.mainMenu.main),e.close(e.controlsMenu.main)})}}B.run(),console.log("Version: 1.4")}]);
//# sourceMappingURL=app.js.map